{% extends "base.html" %}

{% block title %}Complaint Details - Admin{% endblock %}

{% block extra_css %}
<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Admin Complaint Details Section -->
    <section class="about" style="padding-top: 120px;">
        <div class="container">
            <div style="margin-bottom: 2rem;">
                <a href="{{ url_for('admin_view_complaints') }}" class="tech-tag" style="background: var(--bg-secondary); color: var(--text-primary); text-decoration: none; display: inline-block; margin-bottom: 1rem;">
                    ‚Üê Back to Complaints
                </a>
            </div>
            
            <h2 class="section-title fade-in">Complaint Details</h2>
            
            <!-- Temporary Debug Info -->
            <div style="padding: 1rem; background: #f0f0f0; border-radius: 5px; margin-bottom: 1rem; font-family: monospace; font-size: 0.85rem;">
                <strong>info:</strong> 
                Complaint exists: {{ 'Yes' if complaint else 'No' }}
                {% if complaint %}
                <br>Category: {{ complaint.get('category', 'N/A') }}
                <br>Status: {{ complaint.get('status', 'N/A') }}
                <br>location: {{ complaint.get('location', 'N/A') }}
                <br>description: {{ complaint.get('description', 'N/A') }}
                <br>priority: {{ complaint.get('priority', 'N/A') }}
                <br>department: {{ complaint.get('department', 'N/A') }}
                <br>department_code: {{ complaint.get('department_code', 'N/A') }}
                <br>created_at: {{ complaint.get('created_at', 'N/A') }}
                <br>ID: {{ complaint.get('_id', 'N/A') }}
                <br>User: {{ complaint.get('user_name', 'N/A') }}
                {% endif %}
            </div>
            
            {% if complaint %}
            <div class="portfolio-item" style="max-width: 1200px; margin: 0 auto;">
                <div class="portfolio-content">
                    <!-- Complaint Header Card -->
                    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); padding: 2rem; border-radius: 20px; margin-bottom: 2rem; border: 1px solid rgba(99, 102, 241, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1.5rem;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 700;">
                                    {{ complaint.category|default('Unknown Category') }}
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <strong style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Complaint ID</strong>
                                        <p style="margin: 0.25rem 0 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 600;">
                                            {% if complaint.complaint_id %}{{ complaint.complaint_id }}{% elif complaint._id %}{{ complaint._id[:8] }}{% else %}N/A{% endif %}
                                        </p>
                                    </div>
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Department</strong>
                                    <p style="margin: 0.25rem 0 0; color: var(--text-primary); font-size: 1.1rem;">
                                        {{ complaint.department|default('General Department') }}
                                        {% if complaint.department_code %}
                                            <span style="color: var(--text-secondary); font-size: 0.9rem;">({{ complaint.department_code }})</span>
                                        {% endif %}
                                    </p>
                                </div>
                                    <div>
                                        <strong style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Submitted</strong>
                                        <p style="margin: 0.25rem 0 0; color: var(--text-primary); font-size: 1.1rem;">
                                            {{ complaint.created_at|datetime if complaint.created_at else 'N/A' }}
                                        </p>
                                    </div>
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Last Updated</strong>
                                    <p style="margin: 0.25rem 0 0; color: var(--text-primary); font-size: 1.1rem;">
                                        {{ complaint.updated_at|datetime if complaint.updated_at else complaint.created_at|datetime if complaint.created_at else 'N/A' }}
                                    </p>
                                </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end;">
                                <span class="tech-tag" style="background: {{ complaint.status|status_color }}; color: white; font-size: 1rem; padding: 0.75rem 2rem; font-weight: 600; border-radius: 50px;">
                                    {{ complaint.status|default('Pending') }}
                                </span>
                                <span class="tech-tag" style="background: {{ complaint.priority|priority_color }}; color: white; font-size: 0.95rem; padding: 0.5rem 1.5rem; font-weight: 500;">
                                    {{ complaint.priority|default('Normal') }} Priority
                                </span>
                                {% if complaint.is_urgent %}
                                    <span class="tech-tag" style="background: #ef4444; color: white; font-size: 0.95rem; padding: 0.5rem 1.5rem; animation: pulse 2s infinite;">
                                        ‚ö†Ô∏è Urgent
                                    </span>
                                {% endif %}
                                {% if complaint.sla_breached %}
                                    <span class="tech-tag" style="background: #dc2626; color: white; font-size: 0.95rem; padding: 0.5rem 1.5rem;">
                                        ‚è∞ SLA Breached
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- Left Column: User Information -->
                        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px; border-left: 4px solid var(--primary-color);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üë§ User Information
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Full Name</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 500;">{{ complaint.user_name|default('Unknown') }}</p>
                                </div>
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Email Address</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1rem;">
                                        <a href="mailto:{{ complaint.user_email }}" style="color: var(--primary-color); text-decoration: none;">{{ complaint.user_email|default('N/A') }}</a>
                                    </p>
                                </div>
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Phone Number</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1rem;">
                                        <a href="tel:{{ complaint.user_phone }}" style="color: var(--primary-color); text-decoration: none;">{{ complaint.user_phone|default('N/A') }}</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Complaint Metadata -->
                        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px; border-left: 4px solid #10b981;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìã Complaint Information
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Category</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 500;">{{ complaint.category|default('Unknown') }}</p>
                                </div>
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Department</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1rem;">{{ complaint.department|default('General Department') }}</p>
                                </div>
                                {% if complaint.sla_deadline %}
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">SLA Deadline</strong>
                                    <p style="margin: 0.5rem 0 0; color: {% if complaint.sla_breached %}#dc2626{% else %}var(--text-primary){% endif %}; font-size: 1rem; font-weight: {% if complaint.sla_breached %}600{% else %}400{% endif %};">
                                        {{ complaint.sla_deadline|datetime if complaint.sla_deadline else 'N/A' }}
                                        {% if complaint.sla_breached %} ‚ö†Ô∏è{% endif %}
                                    </p>
                                </div>
                                {% endif %}
                                {% if complaint.age %}
                                <div>
                                    <strong style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Complaint Age</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-primary); font-size: 1rem;">{{ complaint.age }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location & Description -->
                    <div style="margin-bottom: 2rem;">
                        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px; margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìç Location
                            </h4>
                            <p style="color: var(--text-primary); font-size: 1.15rem; padding: 1rem; background: white; border-radius: 10px; margin: 0; font-weight: 500; border-left: 4px solid var(--primary-color);">
                                {{ complaint.location|default('Location not provided') }}
                            </p>
                        </div>
                        
                        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìù Description
                            </h4>
                            <div style="padding: 1.5rem; background: white; border-radius: 10px; border-left: 4px solid #10b981;">
                                <p style="color: var(--text-primary); line-height: 1.8; margin: 0; font-size: 1.05rem; white-space: pre-wrap;">{{ complaint.description|default('No description provided') }}</p>
                            </div>
                        </div>
                    </div>
                        
                        {% if complaint.photo %}
                        <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px; margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üì∑ Submitted Photo
                            </h4>
                            <div style="position: relative; border-radius: 15px; overflow: hidden; box-shadow: var(--shadow-lg);">
                                <img src="{{ url_for('static', filename=complaint.photo) }}" 
                                     alt="Complaint photo" 
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'18\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not found%3C/text%3E%3C/svg%3E'"
                                     style="width: 100%; display: block; max-height: 600px; object-fit: contain; background: #f5f5f5;">
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if complaint.proof_images and complaint.proof_images|length > 0 %}
                            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Proof Images (Worker Uploaded)</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                {% for proof in complaint.proof_images %}
                                    <div>
                                        <img src="{{ url_for('static', filename=proof.path) }}" 
                                             alt="Proof image" 
                                             style="width: 100%; border-radius: 10px; box-shadow: var(--shadow-md);">
                                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                                            {{ proof.uploaded_at|datetime if proof.uploaded_at else 'N/A' }}
                                        </small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Activity Timeline -->
                    {% if complaint.activities and complaint.activities|length > 0 %}
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px;">
                        <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìä Activity Timeline
                        </h4>
                        <div style="position: relative; padding-left: 2rem;">
                            <div style="position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary-color) 0%, rgba(99, 102, 241, 0.3) 100%); border-radius: 2px;"></div>
                            {% for activity in complaint.activities %}
                            <div style="margin-bottom: 1.5rem; position: relative; padding-left: 2rem;">
                                <div style="position: absolute; left: -0.5rem; top: 0.25rem; width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                                <div style="background: white; padding: 1rem 1.25rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                                        <strong style="color: var(--text-primary); font-size: 1rem;">{{ activity.action|replace('_', ' ')|title }}</strong>
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">{{ activity.timestamp|datetime if activity.timestamp else 'N/A' }}</small>
                                    </div>
                                    <p style="margin: 0.25rem 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        By: <strong style="color: var(--text-primary);">{{ activity.user_name|default('System') }}</strong>
                                        {% if activity.details %}
                                            {% if activity.details.status %}
                                                - Status: {{ activity.details.status }}
                                            {% endif %}
                                            {% if activity.details.priority %}
                                                - Priority: {{ activity.details.priority }}
                                            {% endif %}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Assignment Section -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px; border: 2px solid rgba(99, 102, 241, 0.2);">
                        <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            ‚öôÔ∏è Assignment & Management
                        </h4>
                        
                        <form id="assignmentForm" style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem; display: block;">Assign to Worker</label>
                                    <select id="worker_id" name="worker_id" style="width: 100%; padding: 0.8rem; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; background: white;">
                                        <option value="">Unassigned</option>
                                        {% for staff in staff_members %}
                                            <option value="{{ staff._id }}" {% if complaint.assigned_to and (complaint.assigned_to|string == staff._id|string or complaint.assigned_to == staff._id) %}selected{% endif %}>
                                                {{ staff.name }} ({{ staff.email }}) - {{ staff.role|upper }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem; display: block;">Priority</label>
                                    <select id="priority" name="priority" style="width: 100%; padding: 0.8rem; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; background: white;">
                                        {% for priority in priorities %}
                                            <option value="{{ priority }}" {% if complaint.priority == priority %}selected{% endif %}>{{ priority }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem; display: block;">Status</label>
                                <select id="status" name="status" style="width: 100%; padding: 0.8rem; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; background: white;">
                                    {% for status in statuses %}
                                        <option value="{{ status }}" {% if complaint.status == status %}selected{% endif %}>{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem; display: block;">Admin Note</label>
                                <textarea id="admin_note" name="admin_note" rows="3" placeholder="Add a note or comment..."
                                          style="width: 100%; padding: 0.8rem; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; font-family: inherit;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button type="submit" class="submit-btn" style="background: var(--gradient-primary); color: white; border: none; padding: 1rem 2rem; border-radius: 50px; font-weight: 600; cursor: pointer;">
                                    Update Complaint
                                </button>
                                <button type="button" id="assignBtn" class="submit-btn" style="background: #10b981; color: white; border: none; padding: 1rem 2rem; border-radius: 50px; font-weight: 600; cursor: pointer;">
                                    Assign to Worker
                                </button>
                            </div>
                        </form>
                        
                        {% if complaint.assigned_staff_name %}
                            <div style="margin-top: 1rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); border-radius: 10px; border-left: 4px solid var(--primary-color);">
                                <strong style="color: var(--text-primary); font-size: 1rem; display: block; margin-bottom: 0.5rem;">‚úÖ Currently Assigned to:</strong>
                                <p style="margin: 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 500;">
                                    {{ complaint.assigned_staff_name }}
                                </p>
                                <p style="margin: 0.25rem 0 0; color: var(--text-secondary); font-size: 0.95rem;">
                                    <a href="mailto:{{ complaint.assigned_staff_email }}" style="color: var(--primary-color); text-decoration: none;">{{ complaint.assigned_staff_email|default('N/A') }}</a>
                                </p>
                            </div>
                        {% else %}
                            <div style="margin-top: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b;">
                                <p style="margin: 0; color: var(--text-primary);">
                                    ‚ö†Ô∏è This complaint is not currently assigned to any staff member.
                                </p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Progress Log -->
                    {% if complaint.progress and complaint.progress|length > 0 %}
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px;">
                        <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìà Progress Log
                        </h4>
                        <div style="position: relative; padding-left: 2rem;">
                            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--primary-color); opacity: 0.3;"></div>
                            {% for progress in complaint.progress %}
                            <div style="margin-bottom: 1.5rem; position: relative;">
                                <div style="position: absolute; left: -1.75rem; top: 0.25rem; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; border: 2px solid white;"></div>
                                <div>
                                    <strong style="color: var(--text-primary);">{{ progress.status }}</strong>
                                    <p style="color: var(--text-secondary); margin: 0.25rem 0 0; font-size: 0.9rem;">
                                        {{ progress.updated_at|datetime if progress.updated_at else 'N/A' }}
                                    </p>
                                    {% if progress.comment %}
                                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0; padding: 0.5rem; background: white; border-radius: 5px;">{{ progress.comment }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Comments Section -->
                    {% if complaint.comments and complaint.comments|length > 0 %}
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 15px;">
                            <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                üí¨ Comments & Notes
                            </h4>
                            {% for comment in complaint.comments %}
                                <div style="padding: 1.25rem; background: white; border-radius: 10px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid var(--primary-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <strong style="color: var(--text-primary); font-size: 1rem;">{{ comment.user_name|default(comment.admin_name)|default('Unknown') }}</strong>
                                            {% if comment.user_role %}
                                                <span style="background: {% if comment.user_role == 'admin' %}var(--primary-color){% elif comment.user_role == 'staff' %}#10b981{% else %}#6b7280{% endif %}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                                    {{ comment.user_role|upper }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">{{ comment.timestamp|datetime if comment.timestamp else 'N/A' }}</small>
                                    </div>
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap;">{{ comment.comment }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Feedback Section -->
                    {% if complaint.feedback and complaint.feedback is not none %}
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(254, 243, 199, 0.8) 0%, rgba(253, 230, 138, 0.8) 100%); border-radius: 15px; border: 2px solid rgba(245, 158, 11, 0.3);">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            ‚≠ê User Feedback
                        </h4>
                        {% if complaint.feedback.rating %}
                        <div style="margin-bottom: 0.5rem;">
                            <strong style="color: var(--text-primary);">Rating: </strong>
                            <span style="font-size: 1.5rem;">
                                {% set rating = complaint.feedback.rating if complaint.feedback.rating else 0 %}
                                {% for i in range(rating) %}‚≠ê{% endfor %}
                                {% for i in range(5 - rating) %}‚òÜ{% endfor %}
                            </span>
                            <span style="color: var(--text-secondary);"> ({{ rating }}/5)</span>
                        </div>
                        {% endif %}
                        {% if complaint.feedback.comments %}
                            <p style="color: var(--text-primary); margin: 0.5rem 0 0; padding: 0.75rem; background: white; border-radius: 8px;">
                                "{{ complaint.feedback.comments }}"
                            </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="portfolio-item" style="max-width: 1000px; margin: 0 auto; text-align: center; padding: 3rem;">
                <div class="portfolio-content">
                    <h3>Complaint Not Found</h3>
                    <p style="color: var(--text-secondary); margin: 1rem 0 2rem;">
                        The complaint you're looking for doesn't exist or could not be loaded.
                    </p>
                    <a href="{{ url_for('admin_view_complaints') }}" class="tech-tag" style="background: var(--primary-color); color: white; text-decoration: none; padding: 0.8rem 1.5rem; display: inline-block;">
                        Back to Complaints
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block extra_js %}
{% if complaint and complaint is not none %}
<script>
    // Update complaint
    const assignmentForm = document.getElementById('assignmentForm');
    const assignBtn = document.getElementById('assignBtn');
    
    if (assignmentForm) {
        assignmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const complaintId = '{{ complaint._id }}';
        const status = document.getElementById('status').value;
        const priority = document.getElementById('priority').value;
        const assignedTo = document.getElementById('worker_id').value;
        const comment = document.getElementById('admin_note').value.trim();
        
        fetch(`/admin/complaint/${complaintId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: status,
                priority: priority,
                assigned_to: assignedTo || null,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Complaint updated successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating complaint: ' + error);
        });
        });
    }
    
    // Assign to worker
    if (assignBtn) {
        assignBtn.addEventListener('click', function() {
        const complaintId = '{{ complaint._id }}';
        const workerId = document.getElementById('worker_id').value;
        const priority = document.getElementById('priority').value;
        const comment = document.getElementById('admin_note').value.trim();
        
        if (!workerId) {
            alert('Please select a worker to assign this complaint to');
            return;
        }
        
        fetch(`/admin/complaint/${complaintId}/assign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                worker_id: workerId,
                priority: priority,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Complaint assigned successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error assigning complaint: ' + error);
        });
        });
    }
</script>
{% endif %}
{% endblock %}

